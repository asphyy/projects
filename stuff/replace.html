<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose"></script>
    <title>Document</title>
</head>

<body>
    <style>
        body {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            background: #121212;
        }

        canvas {
            position: absolute;
            left: 0;
            top: 0;
        }

        video {
            position: absolute;
            top: 100%;
            left: 100%;
        }

        .loading {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-family: monospace;
            font-size: 2em;
            text-align: center;
        }

        .block {
            position: absolute;
            width: 5em;
            height: 5em;
            background: #fff;
            transition: 0.1s all;
        }
    </style>
    <span class='loading'>Loading...</span>
    <video autoplay></video>
    <canvas></canvas>
    <script>
        var canvas = document.querySelector('canvas')
        var ctx = canvas.getContext('2d')
        var completed1 = false
        document.body.onload = async function () {
            var w = document.body.clientWidth
            var h = document.body.clientHeight
            var video = document.querySelector('video')
            canvas.width = w;
            canvas.height = h;
            var ws = hs = 0;
            var chandpoints = [];
            (async function () {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(async function (stream) {
                        video.srcObject = stream;
                        ctx.strokeStyle = '#FFFFFF'
                        video.onloadeddata = async function () {
                            ws = w / video.clientWidth
                            hs = ws
                            var handseen = false
                            var msg = false
                            const model = await handpose.load();
                            setInterval(async function () {
                                chandpoints = []
                                ctx.clearRect(0, 0, w, h)
                                const hands = await model.estimateHands(video);
                                hands.forEach(hand => {
                                    handseen = true
                                    Object.keys(hand.annotations).forEach(function (kt, t) {
                                        var k = hand.annotations[kt]
                                        ctx.beginPath()
                                        ctx.moveTo(w - k[0][0] * ws, k[0][1] * hs)
                                        k.forEach(function (i, v) {
                                            ctx.lineTo(w - i[0] * ws, i[1] * hs)
                                            chandpoints.push(i)
                                        })
                                        ctx.stroke()
                                    })

                                })
                            }, 80)


                            var text = document.querySelector('.loading')
                            text.textContent = 'Move your hand around in front of your webcam'
                            setInterval(function () {
                                if (msg == false) {
                                    if (handseen == true) {
                                        msg = true
                                        text.textContent = 'Cool, right? Try pushing this block out of frame'
                                        var div = document.createElement('div')
                                        document.body.appendChild(div)
                                        div.className = 'block'
                                        div.style.left = '50%'
                                        div.style.top = '55%'
                                        div.style.transform = 'translateX(-50%)'
                                        setInterval(function () {
                                            if (completed1 == false) {
                                                chandpoints.forEach(function (i, v) {
                                                    if (w - i[0] * ws < Number(getComputedStyle(div).left.split('p')[0]) + Number(getComputedStyle(div).width.split('p')[0]) && w - i[0] * ws > Number(getComputedStyle(div).left.split('p')[0])) {
                                                        var dx = w - i[0] * ws - Number(getComputedStyle(div).left.split('p')[0])
                                                        div.style.left = Number(getComputedStyle(div).left.split('p')[0]) - dx + 'px'
                                                        console.log(dx)
                                                    }

                                                })
                                                if (Number(getComputedStyle(div).left.split('p')[0]) < 0 || Number(getComputedStyle(div).left.split('p')[0]) > w) {
                                                    completed1 = true
                                                    document.body.removeChild(div)
                                                    text.textContent = ''
                                                }
                                            }
                                        }, 10)
                                    }
                                }
                            })
                        }
                    })
                    .catch(function (err) {
                        console.log(err)
                    });

            })()
        }
    </script>
</body>

</html>